name: RDP + Tailscale with Data Autosave (SAFE)

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:
        description: "Tailscale tailnet"
        required: true
      ts_api_key:
        description: "Tailscale API key"
        required: true
      ts_authkey:
        description: "Tailscale Auth key"
        required: true
      runtime_minutes:
        description: "Runtime minutes"
        default: "355"

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    # 1️⃣ Restore autosaved data
    - name: Restore autosaved data
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: autosave-data
        path: D:\sourab

    # 2️⃣ Prepare autosave folder
    - name: Prepare autosave folder
      run: |
        New-Item -ItemType Directory -Force -Path D:\sourab
        Write-Host "Autosave folder ready"

    # 3️⃣ Install & connect Tailscale
    - name: Install & Connect Tailscale
      run: |
        $ts="$env:ProgramFiles\Tailscale\tailscale.exe"
        if (-not (Test-Path $ts)) {
          $url="https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $dst="$env:TEMP\tailscale.msi"
          Invoke-WebRequest $url -OutFile $dst
          Start-Process msiexec.exe -ArgumentList "/i","`"$dst`"","/quiet","/norestart" -Wait
        }
        & $ts up --authkey "${{ inputs.ts_authkey }}" --hostname "bullet-rdp"
        & $ts ip -4

    # 4️⃣ Enable RDP (NO user creation)
    - name: Enable RDP (system only)
      run: |
        try {
          Set-ItemProperty `
            "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections -Value 0

          Set-NetFirewallRule `
            -DisplayGroup "Remote Desktop" `
            -Profile Any `
            -Enabled True

          Restart-Service TermService -Force
          Write-Host "RDP enabled (system level)"
        }
        catch {
          Write-Host "⚠️ RDP enable skipped: $($_.Exception.Message)"
        }

    # 5️⃣ Keep alive
    - name: Keep alive
      run: |
        $end = (Get-Date).AddMinutes([int]"${{ inputs.runtime_minutes }}")
        while ((Get-Date) -lt $end) {
          Write-Host "Running at $(Get-Date)"
          Start-Sleep 60
        }

    # 6️⃣ Autosave data
    - name: Autosave data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autosave-data
        path: D:\sourab
        retention-days: 7
